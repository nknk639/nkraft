<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/app :: layout(
        title='ダッシュボード',
        breadcrumbs=~{::breadcrumbs},
        content=~{::content},
        modals=~{::modals},
        scripts=~{::scripts}
      )}">

<!-- Breadcrumbs Fragment -->
<nav th:fragment="breadcrumbs" aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a th:href="@{/budget/}">予算管理</a></li>
        <li class="breadcrumb-item active" aria-current="page">ダッシュボード</li>
    </ol>
</nav>

<!-- Content Fragment -->
<div th:fragment="content">

            <!-- 口座残高カード -->
            <div class="row g-3 mb-4">
                <!-- TODO: Controllerから渡された口座リストをループ表示 -->
                <div th:each="account : ${accounts}" class="col-md-4">
                    <a th:href="@{/budget/transactions(accountId=${account.accountId})}" class="text-decoration-none">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted" th:text="${account.accountName}" th:classappend="${account.isMain} ? 'fw-bold' : ''">口座名</h6>
                                <p class="card-text fs-4 fw-bold text-primary" th:text="'¥' + ${#numbers.formatDecimal(account.balance, 0, 'DEFAULT', 0, 'DEFAULT')}">1,234,567</p>
                            </div>
                        </div>
                    </a>
                </div>
                <!-- 口座がない場合の表示 -->
                <div th:if="${accounts.isEmpty()}" class="col-12">
                    <div class="alert alert-info" role="alert">
                        口座が登録されていません。<a th:href="@{/budget/management}" class="alert-link">マスター管理</a>から登録してください。
                        </div>
                    </div>
                </div>

            <!-- メインコンテンツエリア -->
            <div class="row g-4">
                <div class="col-12">
                    <!-- 取引クイック登録 -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header fw-bold">取引クイック登録</div>
                        <div class="card-body">
                            <!--/* TODO: フォーム実装 (F-B03) */-->
                            <form id="quickAddTransactionForm" th:action="@{/budget/transactions}" method="post" class="needs-validation" novalidate>
                                <div class="row g-3 align-items-center">
                                    <div class="col-auto">
                                        <label for="account" class="col-form-label">口座</label>
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="account" name="accountId" style="width: 120px;" required>
                                            <option value="">選択</option>
                                            <option th:each="acc : ${accounts}"
                                                    th:value="${acc.accountId}"
                                                    th:text="${acc.accountName}"
                                                    th:selected="${acc.isMain}">メイン口座</option>
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <label for="transactionDate" class="col-form-label">取引日</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="date" class="form-control form-control-sm" id="transactionDate" name="transactionDate" style="width: 120px;" required>
                                    </div>
                                    <div class="col-auto">
                                        <label for="amount" class="col-form-label">金額</label>
                                    </div>
                                    <div class="col-auto">
                                        <input type="number" class="form-control form-control-sm" id="amount" name="amount" style="width: 100px;" required>
                                    </div>
                                    <div class="col-auto">
                                        <label for="transactionType" class="col-form-label">取引種別</label>
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="transactionType" name="budgetTransactionTypeId" style="width: 120px;" required>
                                            <option value="">選択</option>
                                            <option th:each="type : ${transactionTypes}"
                                                    th:value="${type.id}"
                                                    th:text="${type.name}">入金</option>
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <label for="category" class="col-form-label">カテゴリ</label>
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="category" name="categoryId" style="width: 120px;">
                                            <option value="">未分類</option>
                                            <option th:each="cat : ${categories}"
                                                    th:value="${cat.id}"
                                                    th:text="${cat.categoryName}">給料</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2 d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <label for="memo" class="visually-hidden">メモ</label>
                                        <input type="text" class="form-control form-control-sm" id="memo" name="memo" placeholder="メモ (任意)">
                                    </div>
                                    <button type="submit" class="btn btn-sm ms-2" style="background-color: var(--sidebar-accent-color); color: var(--sidebar-bg);">登録</button>
                                </div>
                            </form>
                        </div>
                    </div>


                    <!-- 繰り返し予定 -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header fw-bold">繰り返し予定</div>
                        <div class="card-body">
                            <div th:if="${not #lists.isEmpty(recurringTransactions)}" class="d-flex flex-wrap">
                                <form th:each="dto : ${recurringTransactions}" th:with="rt=${dto.recurringTransaction}"
                                      th:action="@{/budget/recurring/{id}/execute(id=${rt.id})}" method="post" class="m-1">
                                    <input type="hidden" name="source" value="dashboard">
                                    <button type="submit" class="btn btn-outline-primary text-start d-flex flex-column" title="実行">
                                        <div style="font-size: 14px;">
                                            <span th:text="${rt.name}"></span>:
                                            <span class="fw-bold" th:text="'¥' + ${#numbers.formatDecimal(rt.amount, 0, 'COMMA', 0, 'POINT')}"></span>
                                        </div>
                                        <small class="text-muted" style="font-size: 11px;">
                                            <span th:if="${dto.latestTransactionDate}" th:text="${#temporals.format(dto.latestTransactionDate, 'yyyy/MM/dd')}"></span>
                                            <span th:unless="${dto.latestTransactionDate}">未実行</span>
                                        </small>
                                    </button>
                                </form>
                            </div>
                            <div th:if="${#lists.isEmpty(recurringTransactions)}">
                                <p class="text-muted text-center mb-0">繰り返し予定はありません。</p>
                            </div>
                        </div>
                    </div>

                    <div th:if="${transactions != null and not #lists.isEmpty(transactions)}" class="card shadow-sm flex-grow-1">
                        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                            取引予定リスト
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="startSimBtn">シミュレーション</button>
                                <button type="button" class="btn btn-sm btn-success d-none" id="saveSimBtn">保存</button>
                                <button type="button" class="btn btn-sm btn-secondary d-none" id="cancelSimBtn">キャンセル</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div style="max-height: 400px; overflow-y: auto;">
                                <!-- F-B03, F-B09 -->
                                <table class="table table-hover mb-0" id="planned-transactions-table">
                                    <thead>
                                    <tr>
                                        <th scope="col" class="handle-col" style="width: 4%; display: none;"></th>
                                        <th scope="col" style="width: 12%;">日付</th>
                                        <th scope="col" style="width: 25%;">内容</th>
                                        <th scope="col" class="text-end" style="width: 15%;">予定額</th>
                                        <th scope="col" class="text-center" style="width: 15%;">実績額</th>
                                        <th scope="col" class="text-center" style="width: 10%;">完了</th>
                                        <th scope="col" class="text-center" style="width: 8%;">操作</th>
                                        <th scope="col" class="text-end" style="width: 15%;">残高</th>
                                    </tr>
                                    </thead>
                                    <tbody id="transactions-body">
                                        <!-- iterStatを使用してループのインデックスを取得 -->
                                        <tr th:each="transaction, iterStat : ${transactions}" th:data-transaction-id="${transaction.transactionId}">
                                            <td class="align-middle text-center handle" style="cursor: grab; display: none;"><i class="fas fa-grip-vertical"></i></td>
                                            <td th:text="${#temporals.format(transaction.transactionDate, 'yyyy-MM-dd')}" class="align-middle transaction-date"></td>
                                            <td class="align-middle">
                                                <span th:text="${transaction.memo}" class="d-block"></span>
                                                <small class="text-muted" th:text="${transaction.categoryName} ?: '未分類'"></small>
                                            </td>                                            
                                            <td class="text-end align-middle">
                                                <span th:text="${transaction.budgetTransactionTypeName == '入金' ? '+' : '-'}" th:classappend="${transaction.budgetTransactionTypeName == '入金' ? 'text-success' : 'text-danger'}"></span>
                                                <span th:text="${#numbers.formatDecimal(transaction.plannedAmount, 0, 'COMMA', 0, 'POINT')}" th:classappend="${transaction.budgetTransactionTypeName == '入金' ? 'text-success' : 'text-danger'}"></span>
                                            </td>
                                            <td class="text-center align-middle">
                                                <input type="number" class="form-control form-control-sm text-end actual-amount-input" th:value="${transaction.plannedAmount}" placeholder="実績額" th:data-transaction-id="${transaction.transactionId}">
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="form-check form-switch d-flex justify-content-center">
                                                    <input class="form-check-input complete-toggle" type="checkbox" role="switch" th:data-transaction-id="${transaction.transactionId}">
                                                </div>
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-secondary edit-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#editTransactionModal"
                                                            th:attr="data-transaction-index=${iterStat.index}"
                                                            title="編集">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger delete-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#deleteConfirmModal"
                                                            th:data-transaction-id="${transaction.transactionId}" title="削除">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="text-end align-middle fw-bold transaction-balance">
                                                <!-- JavaScriptで計算した残高がここに挿入される -->
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div th:if="${transactions == null or #lists.isEmpty(transactions)}" class="card shadow-sm flex-grow-1">
                        <div class="card-body">
                            <p class="text-muted text-center mb-0">メイン口座が設定されていないか、取引予定がありません。</p>
                        </div>
                    </div>
                    
                    <!-- 残高推移予測グラフ -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header fw-bold">残高推移予測</div>
                        <div class="card-body">
                            <!-- TODO: Chart.jsでグラフを描画 (F-B01) -->
                            <canvas id="balanceChart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- 目標・借入一覧 -->
                    <div class="card shadow-sm flex-grow-1">
                        <div class="card-header fw-bold">目標・借入</div>
                        <div class="card-body">
                            <!-- TODO: 目標と借入リストを表示 (F-B06, F-B07) -->
                             <p>ここに目標・借入の一覧が表示されます。</p>
                        </div>
                    </div>
                </div>
            </div> <!-- .row.g-4 の閉じタグ -->
</div>

<div th:fragment="modals">
<div class="modal fade" id="savingsModal" tabindex="-1" aria-labelledby="savingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savingsModalLabel">差額を貯金へ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>予定より少ない支出ですみました。差額を振り替える貯金口座を選択してください。</p>
                <form id="savingsForm">
                    <input type="hidden" id="savingsTransactionId" name="transactionId">
                    <input type="hidden" id="savingsActualAmount" name="actualAmount">
                    <div class="mb-3">
                        <label for="savingsAccountId" class="form-label">振替先口座</label>
                        <select class="form-select" id="savingsAccountId" name="savingsAccountId" required>
                            <option th:each="acc : ${savingsAccounts}" th:value="${acc.accountId}" th:text="${acc.accountName}">貯蓄用口座</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="confirmSavingsBtn">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTransactionModalLabel">取引を編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTransactionForm" th:action="@{/budget/transactions/update}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="redirectUrl" value="/budget/">
                    <input type="hidden" id="editTransactionId" name="transactionId">

                    <div class="mb-3">
                        <label for="editTransactionDate" class="form-label">取引日</label>
                        <input type="date" class="form-control" id="editTransactionDate" name="transactionDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="editAmount" class="form-label">予定額</label>
                        <input type="number" class="form-control" id="editAmount" name="plannedAmount" required>
                    </div>

                    <div class="mb-3">
                        <label for="editTransactionType" class="form-label">取引種別</label>
                        <select class="form-select" id="editTransactionType" name="budgetTransactionTypeId" required>
                            <option th:each="type : ${transactionTypes}" th:value="${type.id}" th:text="${type.name}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editCategory" class="form-label">カテゴリ</label>
                        <select class="form-select" id="editCategory" name="categoryId">
                            <option value="">未分類</option>
                            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.categoryName}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editMemo" class="form-label">メモ</label>
                        <input type="text" class="form-control" id="editMemo" name="memo">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">取引の削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                この取引を削除してもよろしいですか？この操作は元に戻せません。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <!-- このボタンにJavaScriptでIDを設定する -->
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">削除</button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Scripts Fragment -->
<th:block th:fragment="scripts">
<!-- SortableJS for Drag and Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script th:inline="javascript">


    document.addEventListener('DOMContentLoaded', function () {
        // TODO: Controllerからデータを受け取り、グラフを初期化する (F-B01)
        const ctx = document.getElementById('balanceChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['7月', '8月', '9月', '10月', '11月', '12月'], // TODO: 動的なラベル
                    datasets: [{
                        label: '残高予測',
                        data: [1234567, 1384567, 1234567, 1734567, 1584567, 1434567], // TODO: 動的なデータ
                        borderColor: 'rgb(0, 31, 63)',
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function (value) { return '¥' + value.toLocaleString(); }
                            }
                        }
                    }
                }
            });
        }

        // F-B02, F-B03: フロントエンドでの残高計算ロジック
        const calculateBalances = (transactionsToCalculate) => {
            // ThymeleafからJavaオブジェクトを直接受け取る
            const initialBalance = /*[[${mainAccountBalance}]]*/ 0;
            
            if (!transactionsToCalculate || transactionsToCalculate.length === 0) {
                return;
            }

            let currentBalance = initialBalance;

            const rows = document.querySelectorAll('#transactions-body tr');
            if (rows.length !== transactionsToCalculate.length) {
                console.error("DOM-JS Mismatch: The number of rows in the DOM does not match the number of transactions in the JavaScript array.");
                return;
            }

            rows.forEach((row, index) => {
                const transaction = transactionsToCalculate[index];
                const amount = transaction.plannedAmount;                
                const type = transaction.budgetTransactionTypeName;

                if (type === '入金') {
                    currentBalance += amount;
                } else { // 出金 or 振替
                    currentBalance -= amount;
                }

                const balanceCell = row.querySelector('.transaction-balance');
                if (balanceCell) {
                    // 3桁区切りで残高を表示
                    balanceCell.textContent = `¥ ${Math.round(currentBalance).toLocaleString()}`;
                    if(currentBalance < 0){
                        balanceCell.classList.add('text-danger');
                    } else {
                        balanceCell.classList.remove('text-danger');
                    }
                }
                // 日付も更新
                const dateCell = row.querySelector('.transaction-date');
                if (dateCell) {
                    dateCell.textContent = transaction.transactionDate;
                }
            });
        };

        // ページ読み込み時に初回計算を実行
        const initialTransactions = /*[[${transactions}]]*/ [];
        calculateBalances(initialTransactions);

        // --- イベントリスナー設定 ---

        // F-B03: Edit transaction modal logic
        const editTransactionModal = document.getElementById('editTransactionModal');
        if (editTransactionModal) {
            // ThymeleafからJavaScriptにデータを渡す
            const transactions = /*[[${transactions}]]*/ [];
            const transactionTypes = /*[[${transactionTypes}]]*/ [];
            const categories = /*[[${categories}]]*/ [];

            // モーダルが表示される直前のイベントを捕捉
            editTransactionModal.addEventListener('show.bs.modal', event => {
                // イベントのトリガーとなったボタンを取得
                const button = event.relatedTarget;
                // ボタンのdata属性から、編集対象の取引のインデックスを取得
                const transactionIndex = button.getAttribute('data-transaction-index');
                const transaction = transactions[transactionIndex];

                if (!transaction) return;

                const modalForm = editTransactionModal.querySelector('form');

                // フォームの各要素に取引データを設定
                modalForm.querySelector('#editTransactionId').value = transaction.transactionId;
                modalForm.querySelector('#editTransactionDate').value = transaction.transactionDate;
                modalForm.querySelector('#editAmount').value = transaction.plannedAmount;
                modalForm.querySelector('#editMemo').value = transaction.memo || ''; // メモがnullの場合も考慮

                // 取引種別のドロップダウンを選択状態にする
                const typeSelect = modalForm.querySelector('#editTransactionType');
                const typeToSelect = transactionTypes.find(t => t.name === transaction.budgetTransactionTypeName);
                if (typeToSelect) {
                    typeSelect.value = typeToSelect.id;
                }

                // カテゴリのドロップダウンを選択状態にする
                const categorySelect = modalForm.querySelector('#editCategory');
                const categoryToSelect = categories.find(c => c.categoryName === transaction.categoryName);
                if (categoryToSelect) {
                    categorySelect.value = categoryToSelect.id;
                } else {
                    categorySelect.value = ""; // "未分類"の場合
                }
            });
        }

        // F-B03: Complete toggle logic
        document.querySelectorAll('.complete-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const transactionId = this.getAttribute('data-transaction-id');
                const isChecked = this.checked;

                if (!isChecked) {
                    // 現状、完了の取り消しは実装しない
                    this.checked = true;
                    return;
                }

                const row = this.closest('tr');
                const actualAmountInput = row.querySelector('.actual-amount-input');
                const actualAmount = actualAmountInput.value.trim() === '' ? null : actualAmountInput.value;

                // CSRFトークンを取得
                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                const formData = new URLSearchParams();
                formData.append('transactionId', transactionId);
                if (actualAmount !== null) {
                    formData.append('actualAmount', actualAmount);
                }

                // ローディング表示としてトグルを無効化
                this.disabled = true;
                actualAmountInput.disabled = true;

                fetch('/budget/transactions/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    handleCompleteResponse(data, this, actualAmountInput, transactionId);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('通信エラーが発生しました。');
                    this.checked = false;
                    this.disabled = false;
                    actualAmountInput.disabled = false;
                });
            });
        });

        function handleCompleteResponse(data, toggleElement, amountInputElement, transactionId) {
            if (data.success) {
                // F-B09: 差額貯金のモーダル表示判定
                if (data.savingsDifference && data.savingsDifference > 0) {
                    const savingsModal = new bootstrap.Modal(document.getElementById('savingsModal'));
                    document.getElementById('savingsTransactionId').value = transactionId;
                    // 差額をモーダルに表示
                    const savingsModalLabel = document.getElementById('savingsModalLabel');
                    savingsModalLabel.textContent = `差額 ${data.savingsDifference.toLocaleString()} 円を貯金へ`;
                    // 差額をデータ属性として保持
                    savingsModalLabel.dataset.difference = data.savingsDifference;
                    savingsModal.show();
                } else {
                    // 差額貯金がない場合は通常通りリロード
                    window.location.reload();
                }
            } else {
                alert('エラー: ' + (data.message || '不明なエラーが発生しました。'));
                toggleElement.checked = false;
                toggleElement.disabled = false;
                amountInputElement.disabled = false;
            }
        }

        // F-B09: 差額貯金モーダルの確認ボタンのロジック
        document.getElementById('confirmSavingsBtn').addEventListener('click', function() {
            const transactionId = document.getElementById('savingsTransactionId').value;
            const savingsAccountId = document.getElementById('savingsAccountId').value;
            const differenceAmount = document.getElementById('savingsModalLabel').dataset.difference;

            if (!savingsAccountId) {
                alert('貯金先の口座を選択してください。');
                return;
            }

            const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

            const formData = new URLSearchParams();
            formData.append('transactionId', transactionId);
            formData.append('savingsAccountId', savingsAccountId);
            formData.append('differenceAmount', differenceAmount);

            fetch('/budget/transactions/create-savings-transfer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // 成功・失敗にかかわらずページをリロードして最新の状態を反映
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('通信エラーが発生しました。');
            });
        });

        // F-B02: Simulation Logic
        const startSimBtn = document.getElementById('startSimBtn');
        const saveSimBtn = document.getElementById('saveSimBtn');
        const cancelSimBtn = document.getElementById('cancelSimBtn');
        const transactionsBody = document.getElementById('transactions-body');
        const table = document.getElementById('planned-transactions-table');
        let sortable = null;
        let transactionsForSim = []; // シミュレーション用のデータ配列

        if (transactionsBody) {
            sortable = new Sortable(transactionsBody, {
                handle: '.handle', // ドラッグハンドルのクラス名
                animation: 150,
                disabled: true, // 初期状態では無効
                onEnd: function (evt) {
                    // データ配列をDOMの新しい順序に合わせる
                    const movedItem = transactionsForSim.splice(evt.oldIndex, 1)[0];
                    transactionsForSim.splice(evt.newIndex, 0, movedItem);

                    // 移動したアイテムの日付を、移動先の前のアイテムの日付に合わせる
                    // これにより、ユーザーは同じ日に支払いをまとめるシミュレーションができる
                    
                    const newDate = (evt.newIndex > 0)
                        ? transactionsForSim[evt.newIndex - 1].transactionDate
                        : (transactionsForSim.length > 1 ? transactionsForSim[1].transactionDate : transactionsForSim[0].transactionDate);

                    transactionsForSim[evt.newIndex].transactionDate = newDate;
                    
                    // 更新されたデータ配列で残高と日付表示を再計算
                    calculateBalances(transactionsForSim);
                }
            });
        }

        startSimBtn.addEventListener('click', () => {
            // シミュレーション開始時に元のデータをディープコピー
            transactionsForSim = JSON.parse(JSON.stringify(initialTransactions));

            sortable.option('disabled', false); // ドラッグ＆ドロップを有効化
            startSimBtn.classList.add('d-none');
            saveSimBtn.classList.remove('d-none');
            cancelSimBtn.classList.remove('d-none');
            table.classList.add('table-info'); // シミュレーション中であることを視覚的に示す
            document.querySelectorAll('.handle, .handle-col').forEach(el => el.style.display = 'table-cell');
        });

        cancelSimBtn.addEventListener('click', () => {
            window.location.reload(); // 最も簡単なキャンセル方法はリロード
        });

        saveSimBtn.addEventListener('click', () => {
            const updates = transactionsForSim.map(t => ({
                transactionId: t.transactionId,
                newDate: t.transactionDate
            }));

            const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

            fetch('/budget/transactions/update-dates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('保存に失敗しました: ' + (data.message || '不明なエラーが発生しました。'));
                }
            }).catch(error => console.error('Error saving transaction dates:', error));
        });

        // Delete transaction logic
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        if (deleteConfirmModal) {
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let transactionIdToDelete = null;

            // モーダルが表示される直前に、削除対象のIDを保持
            deleteConfirmModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                transactionIdToDelete = button.getAttribute('data-transaction-id');
            });

            // 削除実行ボタンのクリックイベント
            confirmDeleteBtn.addEventListener('click', () => {
                if (!transactionIdToDelete) return;

                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                // RESTfulな慣例に従い、DELETEメソッドを使用し、URLにIDを含める
                fetch('/budget/transactions/' + transactionIdToDelete, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 成功したらモーダルを閉じてからページをリロード
                        const modalInstance = bootstrap.Modal.getInstance(deleteConfirmModal);
                        if (modalInstance) {
                            // モーダルが完全に閉じられた後にリロードする
                            deleteConfirmModal.addEventListener('hidden.bs.modal', () => {
                                window.location.reload();
                            }, { once: true });
                            modalInstance.hide();
                        } else {
                            // フォールバックとして、インスタンスが取得できなくてもリロード
                            window.location.reload();
                        }
                    } else {
                        alert('エラー: ' + (data.message || '削除に失敗しました。'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('通信エラーが発生しました。');
                });
            });
        }
    });
</script>
</th:block>