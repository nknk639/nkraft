# 【要件定義書】NKraft 統合アプリケーション

## 1. 概要

### 1.1. アプリケーションのコンセプト
**『個々の業務をシームレスに連携させ、事業活動全体を加速させる統合業務管理プラットフォーム』**

本アプリケーション「NKraft」は、リード管理、商談管理、予算管理、Todo管理といった個別の業務機能を、統一されたインターフェース上で提供する。各機能が独立して動作するだけでなく、将来的には機能間でデータを連携させることで、事業全体の状況を可視化し、ユーザーの戦略的な意思決定を支援することを目的とする。

### 1.2. 本要件定義書のスコープ
本ドキュメントでは、NKraftアプリケーションに追加する**「予算管理機能」**の要件を定義する。予算管理機能は、未来の入出金予定を基にしたキャッシュフロー予測を中核とし、ユーザーの資金繰り不安を解消することを目的とする。

### 1.3. ターゲットユーザー
- 定期的な収入だけでなく、単発の案件収入がある個人事業主、フリーランス。
- 複数の業務（営業、経理など）を自身で管理し、情報の一元化に課題を感じている小規模事業主。
- **チームや組織で予算情報を共有・管理する必要があるユーザー。**

---

## 2. 機能要件：予算管理モジュール

### 2.0. 認証機能 (Authentication)
| 機能ID | 機能名 | 詳細仕様 |
| :--- | :--- | :--- |
| **F-A01** | **ユーザー認証** | **目的:** ユーザーを識別し、各自のデータへのアクセスをセキュアに管理する。<br>**主要プロセス:**<br>1. ユーザーはログインページで認証情報（ユーザー名、パスワード）を入力する。<br>2. システムは認証情報を検証し、成功した場合はセッションを開始してアプリケーションへのアクセスを許可する。<br>3. ログアウト機能により、ユーザーはセッションを安全に終了できる。<br>**関連データ:** `nkraft_users`(READ) |

### 2.1. 中核機能 (Core Features)
キャッシュフローの可視化とシミュレーションに関する機能群。**全ての機能はログイン中のユーザーに紐づくデータのみを対象とする。**

| 機能ID | 機能名 | 詳細仕様 |
| :--- | :--- | :--- |
| **F-B01** | **残高推移予測グラフ** | **目的:** ユーザーが将来の資金繰りを直感的に把握できるようにする。<br>**主要プロセス:**<br>1. デフォルトでは「メイン口座」の現在の残高を開始点とする。<br>2. 対象口座に紐づく`transactions`テーブルから、全ての`transaction_status = '予定'`の取引を取得する。<br>3. 取得した取引の`planned_amount`（予定額）を使い、時系列に沿って残高を増減させる。<br>4. 計算結果を折れ線グラフとして描画する。<br>5. 残高が設定した閾値（デフォルトは0）を下回るポイントを視覚的にハイライトする。<br>**関連データ:** `accounts`(READ), `transactions` (READ) |
| **F-B02** | **キャッシュフロー・シミュレーション** | **目的:** 支払いのリスケジュールなどを試行し、キャッシュアウトを回避する最適なパターンをユーザー自身が見つけられるようにする。<br>**トリガー:** ユーザーがダッシュボードに表示された「取引予定リスト」の「シミュレーション」ボタンを押す。<br>**主要プロセス:**<br>1. 取引予定リストがドラッグ＆ドロップ可能なモードに切り替わる。<br>2. アイテムの順序が変更されるたびに、クライアントサイドで残高をリアルタイムに再計算する。（計算には`planned_amount`を使用）<br>3. 再計算された結果を元に、取引リストの残高表示とF-B01のグラフを即座に再描画する。<br>4. ユーザーが「保存」を押した時のみ、変更された取引の日付情報をサーバーに送信し、DBを更新する。<br>**関連データ:** `transactions` (READ, UPDATE) |

### 2.2. 取引機能 (Transaction Features)
日々の入出金予定・実績データを操作するための基本的な機能群。**全ての機能はログイン中のユーザーに紐づくデータのみを対象とする。**

| 機能ID | 機能名 | 詳細仕様 |
| :--- | :--- | :--- |
| **F-B03** | **取引の登録・管理** | **目的:** キャッシュフロー予測と実績分析の元となる、全ての入出金データを管理する。<br>**主要プロセス:**<br>1. ユーザーは口座、取引種別、カテゴリを選択し、日付、予定額、メモといった情報を入力する。<br>2. データは`transactions`テーブルに`transaction_status = '予定'`で保存される。<br>3. ユーザーはモーダルウィンドウを通じて、既存の取引を編集、または削除できる。<br>4. ユーザーが取引を`transaction_status = '完了'`にする際、以下の処理を行う。<br>    a. `actual_amount`（実績額）が未入力の場合は、`planned_amount`（予定額）の値をコピーして保存する。<br>    b. `accounts`テーブルの`balance`（口座残高）を、この取引の`actual_amount`に基づいて更新する。（入金なら加算、出金/口座振替なら減算）<br>**関連データ:** `accounts`(UPDATE), `transactions` (CREATE, READ, UPDATE, DELETE), `budget_transaction_types`(READ), `categories`(READ) |
| **F-B04** | **取引一覧と検索** | **目的:** 過去の実績を含む全ての取引履歴の確認や、特定の取引の検索を容易にする。<br>**主要プロセス:**<br>1. 全ての取引を日付の降順でリスト表示する。<br>2. ユーザーは検索フィルター機能を用いて、キーワード、期間、カテゴリ、口座等の条件でリストを絞り込むことができる。<br>3. 各取引アイテムは、F-B03の編集モーダルを開くトリガーとなる。<br>**関連データ:** `transactions` (READ) |

### 2.3. マスター管理機能 (Master Data Management Features)
取引データを効率的に生成・管理するための、各種マスターデータに関する機能群。**全ての機能はログイン中のユーザーに紐づくデータのみを対象とする。**

| 機能ID | 機能名 | 詳細仕様 |
| :--- | :--- | :--- |
| **F-B05** | **繰り返し予定の管理** | **目的:** 毎月発生する固定費などを一度登録するだけで、入力の手間を省く。<br>**主要プロセス:**<br>1. **ルール作成:** ユーザーはルール名、金額、カテゴリ、メモ、対象口座と共に、繰り返しルールを設定する。<br>    a. **ルール種別:** 「毎月」または「毎週」から選択する。<br>    b. **実行日:** 「毎月」選択時は日にち（1-31）を、「毎週」選択時は曜日（日-土）を指定する。<br>2. **繰り返し予定の実行:** ユーザーがダッシュボード上の繰り返し予定ボタンを押すと、システムは該当ルールで登録された最も未来の取引を検索し、その日付を基点に次の予定日を計算して、新たな取引予定を1件登録する。<br>**関連データ:** `recurring_transactions` (CREATE, READ, UPDATE, DELETE), `transactions` (CREATE) |
| **F-B06** | **借入管理** | **目的:** 返済計画をキャッシュフローに統合し、管理を容易にする。<br>**主要プロセス:**<br>1. **一覧画面:** ユーザーは借入のマスターデータ（借入名、総額）を登録する。既存の借入は返済率を示すプログレスバーと共にリスト表示される。<br>2. **詳細画面:** 特定の借入に対する返済をクイック入力フォームから登録する。この操作により、`transactions`と`repayments`にレコードが作成される。<br>3. **データフロー:** 返済に紐づく取引が「完了」ステータスになった際、`borrows`テーブルの返済済み金額が更新される。<br>**関連データ:** `borrows` (C/R/U), `repayments` (C/R/D), `transactions` (C/R/D) |
| **F-B07** | **目標管理** | **目的:** 貯金などの目標達成に向けたモチベーションを維持し、進捗を可視化する。<br>**主要プロセス:**<br>1. **一覧画面:** ユーザーは目標のマスターデータ（目標名、目標金額）を登録する。既存の目標は達成率を示すプログレスバーと共にリスト表示される。<br>2. **詳細画面:** 特定の目標に対する積立をクイック入力フォームから登録する。この操作により、`transactions`と`goal_achievements`にレコードが作成される。<br>3. **データフロー:** 積立に紐づく取引が「完了」ステータスになった際、`goals`テーブルの積立済み金額が更新される。<br>**関連データ:** `goals` (C/R/U), `goal_achievements` (C/R/D), `transactions` (C/R/D) |
| **F-B08** | **口座管理** | **目的:** アプリ内で管理する預金口座や財布（ウォレット）を定義・管理する。<br>**主要プロセス:**<br>1. ユーザーはマスター管理ページで、新規口座（口座名、初期残高）を作成できる。<br>2. 既存の口座情報の編集、および削除が可能。<br>**関連データ:** `accounts` (CREATE, READ, UPDATE, DELETE) |
| **F-B12** | **カテゴリ管理** | **目的:** 取引の分類に使用するカテゴリをユーザー自身が定義・管理できるようにする。<br>**主要プロセス:**<br>1. ユーザーはマスター管理ページで、新規カテゴリ（カテゴリ名）を作成できる。<br>2. 既存のカテゴリ名の編集、および削除が可能。<br>**関連データ:** `categories` (CREATE, READ, UPDATE, DELETE) |
| **F-B13** | **論理削除** | **目的:** ユーザーの誤操作によるデータ損失を防ぎ、データの完全性を保つ。<br>**主要プロセス:**<br>1. ユーザーが削除操作を行うと、対象レコードは物理的に削除されず、`is_deleted`フラグが`1`に更新される。<br>2. アプリケーションは原則として`is_deleted = 0`のレコードのみを有効なデータとして扱う。<br>**対象テーブル:** `transactions`, `accounts`, `categories`, `recurring_transactions`, `borrows`, `goals` |

### 2.4. 資産管理・レポート機能 (Asset & Report Features)
資産の全体像を管理し、分析と改善を支援する機能群。**全ての機能はログイン中のユーザーに紐づくデータのみを対象とする。**

| 機能ID | 機能名 | 詳細仕様 |
| :--- | :--- | :--- |
| **F-B09** | **差額の自動貯金** | **目的:** 予定より支出が少なかった場合に、差額を自動的に貯金へ回すことで、無意識の浪費を防ぎ、資産形成を促進する。<br>**トリガー:** ユーザーが支出「予定」を「完了」にする際、予定額より少ない実績額を入力する。<br>**主要プロセス:**<br>1. システムは `(planned_amount - actual_amount)` の差額を計算する。<br>2. 元の支出取引を実績額で`transactions`に更新する。<br>3. 差額分の新たな取引を2件自動生成する。<br>    a. **取引1:** 取引種別「口座振替」、金額「差額」、口座「元の支出口座」、カテゴリ・メモ「元の取引情報を引用」<br>    b. **取引2:** 取引種別「入金」、金額「差額」、口座「指定された貯金用口座」<br>**関連データ:** `transactions` (CREATE, UPDATE) |
| **F-B10**| **口座振替のクイック入力** | **目的:** ユーザーが手動で口座間の資金移動を簡単に行えるようにする。<br>**トリガー:** ユーザーがクイック入力フォームで取引種別「口座振替」を選択する。<br>**主要プロセス:**<br>1. 振替元口座（デフォルトはメイン口座）と、振替先口座を選択するUIが表示される。<br>2. ユーザーが金額を入力して登録すると、システムは2件の取引を自動生成する。<br>    a. **取引1:** 取引種別「口座振替」、金額「入力額」、口座「振替元口座」<br>    b. **取引2:** 取引種別「入金」、金額「入力額」、口座「振替先口座」<br>**関連データ:** `transactions` (CREATE) |
| **F-B11**| **月次予実レポート** | **目的:** 月単位での予算と実績の乖離をカテゴリ別に可視化し、予算管理の精度向上を支援する。<br>**トリガー:** ユーザーが予実レポートページにアクセスし、対象月を選択する。<br>**主要プロセス:**<br>1. 対象月の全ての「完了」ステータスの取引を取得する。<br>2. カテゴリごとに`planned_amount`の合計（予算）と`actual_amount`の合計（実績）を集計する。<br>3. カテゴリ別に、予算と実績を並べて表示する棒グラフを生成する。<br>**関連データ:** `transactions` (READ), `categories`(READ) |

---

## 3. 画面仕様

### 3.1. 共通レイアウト
- **ヘッダー:** アプリケーション名「NKraft」、ログインユーザー名、ユーザーアイコンを表示する共通領域。
- **サイドバー:** アプリケーションの全機能モジュール（リード管理、商談管理、予算管理など）へアクセスするためのアコーディオン形式のナビゲーションメニュー。

### 3.2. 予算管理モジュールの画面一覧
| 画面名 | URL | 概要 | 主要機能 | 関連DB |
| :--- | :--- | :--- | :--- | :--- |
| **ログインページ** | `/login` | アプリケーションへのアクセス認証を行う。 | `F-A01` | `nkraft_users` |
| **ダッシュボード** | `/budget/` | **未来のキャッシュフロー予測に特化したトップページ。**<br>**【表示コンポーネント】**<br>1. **取引入力フォーム:** 新規の取引予定を登録する。<br>2. **繰り返し予定ボタン:** アコーディオン形式で表示。ボタンクリックで次の予定を生成。<br>3. **残高推移予測グラフ:** 全ての予定取引を基にした未来の残高推移を可視化。<br>4. **取引予定リスト:** グラフの元データとなる全予定取引をリスト表示。スクロール可能。各行に実績額入力欄、完了/編集/**削除**ボタンを配置。表示項目は `transaction_date`, `planned_amount`, `actual_amount`, `budget_transaction_type_name`, `category_name`。 <br>5. **口座残高カード:** 各口座の現在残高をカード形式で表示。クリックで取引一覧へ遷移。<br>6. **目標・借入一覧:** 各マスターデータのサマリーをリスト表示。 | `F-B01`, `F-B02`, `F-B03`, `F-B05`, `F-B10`, `F-B13` | `nkraft_users`, `accounts`, `transactions`, `borrows`, `goals` |
| **取引一覧** | `/budget/transactions` | 全ての取引（過去の実績含む）を詳細に確認・管理する。**口座切り替えフィルターを持つ。** | `F-B04`, `F-B03`, `F-B13` | `transactions` |
| **予実レポート** | `/budget/report` | **過去の実績分析に特化。**月次の予実をカテゴリ別棒グラフで比較する。 | `F-B11` | `transactions` |
| **借入一覧** | `/budget/borrows` | 登録されている全ての借入を管理する。 | `F-B06` (一覧, 新規), `F-B13` | `borrows` |
| **借入詳細** | `/budget/borrows/{id}` | 特定の借入に対する返済を記録・管理する。 | `F-B06` (詳細), `F-B03` | `borrows`, `repayments`, `transactions` |
| **目標一覧** | `/budget/goals` | 登録されている全ての目標を管理する。 | `F-B07` (一覧, 新規), `F-B13` | `goals` |
| **目標詳細** | `/budget/goals/{id}` | 特定の目標に対する積立を記録・管理する。 | `F-B07` (詳細), `F-B03` | `goals`, `goal_achievements`, `transactions` |
| **繰り返し予定** | `/budget/recurring` | 定期的な入出金ルールを管理する。ルール種別に応じて動的に入力フォームが変化する。 | `F-B05`, `F-B13` | `recurring_transactions` |
| **マスター管理** | `/budget/management` | **口座やカテゴリなどのマスターデータを管理する。タブで各管理機能を切り替える。** | `F-B08`, `F-B12`, `F-B13` | `accounts`, `categories` |

---

## 4. データモデル（テーブル設計案）
*予算管理モジュールが使用するテーブル。主キーは `テーブル名_id` 形式とする。*

- **`nkraft_users` (ユーザーマスタ)**
  - `nkraft_user_id` (PK)
  - `username`
  - `password`
- **`accounts` (口座マスタ)**
  - `account_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `account_name`
  - `balance` (現在の残高)
  - `is_main` (TINYINT(1))
  - `is_savings` (TINYINT(1))
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`budget_transaction_types` (取引種別マスタ)**
  - `budget_transaction_type_id` (PK)
  - `budget_transaction_type_name`
- **`categories` (カテゴリマスタ)**
  - `category_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `category_name`
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`transactions` (取引)**
  - `transaction_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `account_id` (FK: `accounts`)
  - `budget_transaction_type_id` (FK: `budget_transaction_types`)
  - `category_id` (FK: `categories`, NULL許容)
  - `transaction_date`
  - `planned_amount` (予定額)
  - `actual_amount` (実績額, NULL許容)
  - `transaction_status` (ENUM('予定', '完了') NOT NULL DEFAULT '予定')
  - `memo`
  - `recurring_id` (FK: `recurring_transactions`)
  - `borrow_id` (FK: `borrows`)
  - `goal_id` (FK: `goals`)
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`recurring_transactions` (繰り返し予定)**
  - `recurring_transaction_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `recurring_transaction_name`
  - `account_id` (FK: `accounts`)
  - `budget_transaction_type_id` (FK: `budget_transaction_types`)
  - `category_id` (FK: `categories`, NULL許容)
  - `amount`
  - `memo`
  - `rule_type` (ENUM('毎月', '毎週'))
  - `day_of_month` (INTEGER, 1-31, `rule_type`が'毎月'の場合に利用)
  - `day_of_week` (INTEGER, 0-6 for Sun-Sat, `rule_type`が'毎週'の場合に利用)
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`borrows` (借入)**
  - `borrow_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `borrow_name`
  - `total_amount`, `repaid_amount`
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`repayments` (返済履歴)**
  - `repayment_id` (PK)
  - `transaction_id` (FK: `transactions`)
  - `borrow_id` (FK: `borrows`)
- **`goals` (目標)**
  - `goal_id` (PK)
  - `nkraft_user_id` (FK: `nkraft_users`)
  - `goal_name`
  - `target_amount`, `saved_amount`
  - `is_deleted` (TINYINT(1) DEFAULT 0)
- **`goal_achievements` (目標達成履歴)**
  - `goal_achievement_id` (PK)
  - `transaction_id` (FK: `transactions`)
  - `goal_id` (FK: `goals`)

### 4.1. 初期データ (Initial Data)
- **`nkraft_users` テーブル**
  - アプリケーションの初期状態で、以下のユーザーが登録されているものとする。
    - username: `test`, password: `test`
    - username: `natsuki`, password: `mm5c53um`

---

## 5. 非機能要件

### 5.1. UI/UX設計方針
- **統合されたUI:** 提供されたデザイン案に基づき、ヘッダーとサイドバーを共通コンポーネントとして全ページに配置する。
- **モジュール型ナビゲーション:** サイドバーにより、ユーザーは各機能モジュール間を直感的に行き来できる。
- **情報設計:** 「未来予測（ダッシュボード） → 実績分析（レポート） → データ管理（その他一覧）」という明確な役割分担に基づき、ユーザーを迷わせない画面遷移を実現する。
- **カラースキーム:** プライマリカラーを `#001f3f`、アクセントカラーを `#87CEEB` とする。

### 5.2. パフォーマンス
- シミュレーションモードでの残高・グラフの再計算は、クライアントサイドで高速に処理を完結させる。
- データベースへの書き込みは、ユーザーの操作が完了したタイミングに限定し、不要な通信を避ける。

---

## 6. 開発・テスト計画

### 6.1. 技術スタック
- **テンプレートエンジン:** Thymeleaf 3
- **フロントエンド:** HTML5 / CSS3 (Bootstrap 5.3 CDN), JavaScript (ES2020, Chart.js 4)
- **バックエンド:** Java 17, Spring Boot 3, **Spring Security**
- **データベース:** MySQL 8.x
- **DBマイグレーション:** Flyway
- **ビルドツール:** Maven 3.9 (spring-boot-maven-plugin を利用し単一JARを生成)

### 6.2. ファイル/ディレクトリ構成（Maven標準構成）
*各機能モジュールでパッケージを分離し、将来の拡張性を確保する。*
```
src
├── main
│   ├── java
│   │   └── com/nkraft
│   │       ├── budget      // ★予算管理モジュール
│   │       │   ├── controller
│   │       │   ├── service
│   │       │   ├── repository
│   │       │   └── entity
│   │       ├── user        // ★ユーザー・認証関連
│   │       ├── config      // (共通設定, SecurityConfigなど)
│   │       └── NkraftApplication.java
│   └── resources
│       ├── static
│       │   ├── css
│       │   └── js
│       ├── templates
│       │   ├── budget      // ★予算管理テンプレート
│       │   ├── lead        // (リード管理テンプレート)
│       │   ├── login.html  // ★ログイン画面
│       │   └── layout      // (共通レイアウト)
│       └── db/migration    // Flywayマイグレーションスクリプト
└── test
    └── java
        └── com/nkraft
            └── budget
```

### 6.3. テスト方針

#### 6.3.1. 単体テスト (Unit Test)
- **対象:** `Service`クラスのビジネスロジック。
- **方針:** `JUnit 5` と `Mockito` を使用し、各モジュールのロジックを独立して検証する。

#### 6.3.2. 結合テスト (Integration Test)
- **対象:** `Controller`からデータベースに至る一連の処理フロー。
- **方針:** `@SpringBootTest` を利用。`Testcontainers`でMySQL環境を構築し、各機能モジュールのエンドツーエンドの動作を検証する。**認証済みユーザーとしてのテストも実施する。**

### 6.4. Geminiを活用した開発アプローチ

#### 6.4.1. 基本方針
- **要件定義書を正とする:** 本書を唯一の正しい情報源（Single Source of Truth）とし、Geminiへの指示（プロンプト）の基盤とする。
- **ボトムアップ・アプローチ:** 「データモデル → ビジネスロジック → UI」の順で、下層から上層へと機能を積み上げる形で開発を進める。
- **テスト駆動:** 機能実装と単体テストをセットで進め、品質を早期に確保する。

#### 6.4.2. 開発ステップとGemini活用例
| ステップ | 主な作業内容 | Geminiへの指示（プロンプト）例 |
| :--- | :--- | :--- |
| **1. 基盤構築** | ・Flywayによるテーブル作成<br>・JPAエンティティクラスの作成<br>・Spring Data JPAリポジトリの作成 | 「要件定義書4章を基に、`transactions`テーブルのJPAエンティティクラスを作成して。」<br>「`Transaction`エンティティに対するSpring Data JPAリポジトリのインタフェースを作成して。」 |
| **2. ビジネスロジック実装** | ・サービスクラスの作成<br>・機能要件に基づいたメソッド実装<br>・JUnit5とMockitoによる単体テスト | 「機能要件F-B03を実装する`TransactionService`クラスの骨子を作成して。」<br>「`TransactionService`の取引完了処理について、正常系と異常系の単体テストケースを生成して。」 |
| **3. UIとAPIの実装** | ・コントローラークラスの作成<br>・Thymeleafによる画面テンプレート作成<br>・Chart.js等を利用したJavaScript実装 | 「画面仕様3.2のダッシュボードのControllerメソッドを作成して。必要なデータを`Model`に格納して。」<br>「Bootstrap 5を使い、ダッシュボードの取引予定リスト部分のThymeleafテンプレートを作成して。」<br>「機能F-B01を実装するChart.jsのコードを生成して。データはControllerからJSONで受け取る想定で。」 |
| **4. 結合と反復** | ・`@SpringBootTest`による結合テスト<br>・画面と機能のE2E（エンドツーエンド）確認<br>・デバッグとリファクタリング | 「取引を完了させても口座残高が更新されない。関連する`Controller`, `Service`, `JavaScript`のコードをレビューし、原因を特定して。」<br>「このサービスクラスのコードは冗長なので、よりクリーンなコードにリファクタリングして。」 |
